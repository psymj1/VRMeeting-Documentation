<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../styles/base.css">
    </head>
    <title>VRMeeting - Messaging Protocol v2.0.0</title>
    <body>
        <a name="top"></a>
        <h1>VRMeeting - Messaging Protocol v2.0.0 - <a href="../pages/developerdocs.html">Return to Developer Docs</a></h1>
        <hr>
        <h2>Key Words - <a href="#top">Back to top</a></h2>
        <ul>
            <li><b>VRMeeting Client</b><ul>A device communicating with the server. Usually a mobile device running the VRMeeting App</ul></li>
            <li><b>VRMeeting Host Server</b><ul>The VRMeeting Server that acts as an intermediate between 2 clients allowing them to communicate.</ul></li>
            <li><b>Message</b><ul>A construct consisting of a series of bytes encoded in a particular way to represent the data that needs to be sent between the clients and server</ul></li>
            <li><b>Signal</b><ul>Part of a Message. It denotes the type of a message, describing the type of the data it is carrying and what the message represents. It's encoded in ASCII</ul></li>
            <li><b>Payload</b><ul>Part of a Message. Used to transfer information from a client to either the server or another client. Not all messages require a payload</ul></li>
            <li><b>Authentication Token</b><ul>A Token generated by the server when the user logs in. The token is only valid for <b>24</b> hours</ul></li>
            <li><b>Audio Segment</b><ul>Refers to the audio data generated from recording audio for a given amount of time. This is made up of a 1D float array. When being transmitted this will translated to a byte array and then compressed and split into multiple messages</ul></li>
            <li><b>Meeting ID</b><ul>Used  with Meeting Code. The code that is used to uniquely identify any given meeting. This is provided when you first create a meeting</ul></li>
            <li><b>Event</b><ul>An action that occurs on the server as a result of a client sending a message to the server</ul></li>
        </ul>
        <p>A summary of the system can be found <a href="../pages/overview.html">here</a></p>
        <hr>
        <h2>Message - <a href="#top">Back to top</a></h2>
        <p>A message is made up of a <b>Signal</b> and a <b>Payload</b>. In order to discern between the end of the siganl and the end of the payload delimiters are used.</p>
        <p>After the signal, <b>\n</b> is put in ASCII. This is followed by the payload. After the payload comes a UUID <b>d11ebd74585511e89c2dfa7ae01bbebc</b>.</p>
        <p>The UUID is used to denote the end of the payload as it is highly-unlikely for that exact series of characters to be replicated in data being sent that isn't intended to be interpreted as ASCII such as audio.</p>
        <h3>Example:</h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Signal Delimiter</th>
                    <th>Payload</th>
                    <th>Payload Delimiter</th>
                </tr>
                <tr>
                    <td>UDM</td>
                    <td>\n</td>
                    <td>{"userID":1, "firstName":"FirstName",  "surName":"SurName", "company":"CompanyName", "jobTitle":"JobTitle", "workEmail":"WorkEmail", "phoneNumber":"01234567891", "avatarID":1, "presenting":true}</td>
                    <td>d11ebd74585511e89c2dfa7ae01bbebc</td>
                </tr>
            </table>
        <p>In this example the message has a <b>UDM</b> signal. This indicates the message is transmitting User Data <i>(UDM stands for User Data Message)</i></p>
        <p>This is followed by the <b>\n</b> delimiter and then the payload of the User Data. The payload is then capped off with the UUID</p>
        <hr>
        <h2>Message Types - <a href="#top">Back to top</a></h2>
        <p>The protocol consists of many different types of messages, each with their own purpose and origin.</p>
        <p>There are 3 scenarios where messages are used to send information:</p>
        <ol>
            <li>From <b>Client</b> to <b>Server</b></li>
            <li>From <b>Server</b> to <b>Client</b></li>
            <li>From <b>Client</b> to <b>Server</b> &amp <b>Server</b> to <b>Client</b></li>
        </ol>
        <p>Below you'll find a full list of the types of messages and their uses</p>
        <p><b>Note:</b> If you click on the signal of a message you will be shown a summary</p>
        <table>
            <tr>
                <th>Message Signal</th>
                <th>Message Purpose</th>
            </tr>
            <tr>
                <td><a href="#AUTH">AUTH</a></td>
                <td>Sent from the server to a client to request the client's Authentication Token</td>
                
            </tr>
            <tr>
                <td><a href="#TOKE">TOKE</a></td>
                <td>Sent from the client to the server when the client is asked for its Authentication Token</td>
            </tr>
            <tr>
                <td><a href="#VAL">VAL</a></td>
                <td>Sent from the server to the client to tell them their Authentication Token and MeetingID were valid</td>
            </tr>
            <tr>
                <td><a href="#NVAL">NVAL</a></td>
                <td>Sent from the server to the client to say their Authentication Token or MeetingID were invalid.<br> <b>Note:</b> The connection to the server will be terminated after this message is sent</td>
            </tr>
            <tr>
                <td><a href="#CHNG">CHNG</a></td>
                <td>Used to indicate a change in presentation slide. Sent from:
                    <ul>
                    <li>A client to the server, the server will respond by broadcasting the message to all clients in that client's meeting including the sender</li>
                    <li>The server to a client, When the client receives this message it should download the specified image from the web server and display it in Unity</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><a href="#AUDI">AUDI</a></td>
                <td>Transfers audio data from a client to another. The data contained in the payload will not be raw audio data. It's been compressed using Java's <a href="https://docs.oracle.com/javase/8/docs/api/java/util/zip/Deflater.html">Deflater</a>
                    <br>This is then split up so 1 message only contains part of the data. Sent From:
                    <ul>
                        <li>A client to the server, the server responds by broadcasting the ‘message’ to all users in that client’s meeting other than the presenter</li>
                        <li>The server to a client, the client should extract the payload from the message and append it to the end of a buffer until it receives a <b>EAUD</b> message indicating all of the audio for this segment has been transmitted</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><a href="#EAUD">EAUD</a></td>
                <td>Indicates to a client that they have received all of the data from an Audio Segment and so they need to decompress their availble data to create a new Audio Segment
                    <ul>
                        <li>Sent from a client to the server, the server will then send this message to all clients in the meeting except the presenter <i>(Note: The presenter will be the person to send the EAUD message)</i></li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><a href="#END">END</a></td>
                <td>Sent to indicate that a meeting should close
                    <ul>
                        <li>A client to the server, the server responds by broadcasting the message to all the clients in the meeting</li>
                        <li>The server to a client, when the client receives this message it should send a <b>GONE</b> message to the server to indicate it is leaving and then close the connection to the server</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td><a href="#MEET">MEET</a></td>
                <td>Sent from the server to the client to ask for the ID of the meeting the client wants to join</td>
            </tr>
            <tr>
                <td><a href="#MID">MID</a></td>
                <td>Sent from the client to the server in response to a MEET message. It contains the MeetingID the client wants to join</td>
            </tr>
            <tr>
                <td><a href="#GAP">GAP</a></td>
                <td>Sent from the client to the server. It requests the server sends the client the user data for every client in their meeting. The server responds by sending a series of <b>UDM</b> messages equal to the number of clients currently in the meeting. This includes the client who sent the GAP message</td>
            </tr>
            <tr>
                <td><a href="#UDM">UDM</a></td>
                <td>Sent from the server to the client. It contains all of the public User Data about a client in a meeting including whether they are presenting or not</td>
            </tr>
            <tr>
                <td><a href="#HERE">HERE</a></td>
                <td>Sent from the client to the server to request their arrival in the meeting is announced to every other pariticpant in the meeting. This results in sending a UDM message to every <b>Other</b> client in the meeting</td>
            </tr>
            <tr>
                <td><a href="#GONE">GONE</a></td>
                <td>Sent from the client to the server to indicate to the server that they will be leaving the meeting. This will prompt the server to send a <b>LEFT</b> message to everyone else in the meeting</td>
            </tr>
            <tr>
                <td><a href="#LEFT">LEFT</a></td>
                <td>Sent from the server to all clients in the meeting except the client who it states has left. It indicates that the given user has left the meeting </td>
            </tr>
            <tr>
                <td><a href="#HRTB">HRTB</a></td>
                <td>Sent from the client to the server at regular intervals to indicate the user is still present in the meeting to avoid being disconnected.<br><b>Note:</b> This must be sent before every <b>15</b> interval after the user joins otherwise the user will be disconnected</td>
            </tr>
        </table>
        <hr>
        <h2>Message Summaries - <a href="#top">Back to top</a></h2>
        <p>Each message type below contains a brief summary of the message and outlines its format</p>
        <h3><a name="AUTH">AUTH - Requesting Authentication Token</a></h3>
        <table>
            <tr>
                <th>Signal</th>
                <th>Payload</th>
                <th>Source -> Recipient</th>
            </tr>
            <tr>
                <td>AUTH</td>
                <td>EMPTY</td>
                <td>Server -> Client</td>
            </tr>
        </table>
        <h3><a name="TOKE">TOKE - Sending Authentication Token</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>TOKE</td>
                    <td>The Authentication Token of the user encoded in ASCII</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <h3><a name="VAL">VAL - You have successfully authenticated with the server</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>VAL</td>
                    <td>EMPTY</td>
                    <td>Server -> Client</td>
                </tr>
            </table>
        <h3><a name="NVAL">NVAL - You failed to successfully authenticate with the server</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>NVAL</td>
                    <td>EMPTY</td>
                    <td>Server -> Client</td>
                </tr>
            </table>
        <h3><a name="CHNG">CHNG - Change the presentation to slide X</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>CHNG</td>
                    <td>The slide number to change to as a 4 byte <a href="https://en.wikipedia.org/wiki/Endianness">little endian</a> integer</td>
                    <td>Client -> Server -> Client</td>
                </tr>
            </table>
        <h3><a name="AUDI">AUDI - Sending part of a compressed audio segment</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>AUDI</td>
                    <td>Compressed Audio Data</td>
                    <td>Client -> Server -> Client</td>
                </tr>
            </table>
        <h3><a name="EAUD">EAUD - End of Audio, You've received all of the data required to decompress the next audio segment</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>EAUD</td>
                    <td>EMPTY</td>
                    <td>Client -> Server -> Client</td>
                </tr>
            </table>
        <h3><a name="END">END - The meeting has ended</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>END</td>
                    <td>EMPTY</td>
                    <td>Client -> Server -> Client</td>
                </tr>
            </table>
        <h3><a name="MEET">MEET - Requesting ID of meeting to join</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>MEET</td>
                    <td>EMPTY</td>
                    <td>Server -> Client</td>
                </tr>
            </table>
        <h3><a name="MID">MID - Sending ID of meeting to join</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>MID</td>
                    <td>The Meeting Code for the meeting the user wants to join encoded in ASCII</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <h3><a name="GAP">GAP - Get All Participants - Send me all of the participants in my meeting</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>GAP</td>
                    <td>EMPTY</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <h3><a name="UDM">UDM - User Data Message - A message containing all public information on a user</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>UDM</td>
                    <td>The User information encoded in ASCII, in JSON format as a set of Key-Value Pairs: 
                        <ul>
                                <li>userID - integer</li>
                                <li>firstName - ASCII String</li>
                                <li>surName - ASCII String</li>
                                <li>Company - ASCII String</li>
                                <li>jobTitle - ASCII String</li>
                                <li>workEmail - ASCII String</li>
                                <li>phoneNumber - ASCII String</li>
                                <li>avatarID - integer</li>                                
                        </ul>
                    </td>
                    <td>Server -> Client</td>
                </tr>
            </table>
        <h3><a name="HERE">HERE - I have just joined the meeting</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>HERE</td>
                    <td>EMPTY</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <h3><a name="GONE">GONE - I have just left the meeting</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>GONE</td>
                    <td>EMPTY</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <h3><a name="LEFT">LEFT - This user has left the meeting</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>LEFT</td>
                    <td>The ID of the user who left the meeting</td>
                    <td>Server -> Client</td>
                </tr>
            </table>
        <h3><a name="HRTB">HRTB - Heartbeat Message, I'm still here</a></h3>
        <table>
                <tr>
                    <th>Signal</th>
                    <th>Payload</th>
                    <th>Source -> Recipient</th>
                </tr>
                <tr>
                    <td>HRTB</td>
                    <td>EMPTY</td>
                    <td>Client -> Server</td>
                </tr>
            </table>
        <hr>
        <h2>Authenticating with the Host Server - <a href="#top">Back to top</a></h2>
        <p>In order to authenticate with the host server, the client must first have received an Authentication Token from the Web Server. This is obtained by providing a valid email-password pair.</p>
        <p>Next, the client must open a TCP connection to the Host Server</p>
        <p>The Host Server will send an <b>AUTH</b> message to the client indicating that it wants the client's Authetnication Token</p>
        <p>The client must send back a valid Authentication Token in a <b>TOKE</b> message</p>
        <p>If the client fails to send a valid message, valid Authentication Token or doesn't respond in <b>1</b> second, then the server will close the connection</p>
        <p>Once the server receives the valid Authentication Token, it will then send a <b>MEET</b> message to the client, indicating it wants the ID of the meeting the client wants to join</p>
        <p>The client must respond with a valid Meeting ID in a <b>MID</b> Message within <b>1</b> second otherwise the server will close the connection</p>
        <p>The server will validate the Authentication Token and MeetingID against the Web Server. If either are invalid then the server will send a <b>NVAL</b> message to the client and close the connection</p>
        <p>If both are valid then the client will be sent a <b>VAL</b> message indicating it has successfully authetnicated with the Host Server, and the client will be added to the meeting they specified</p>
        <p>The client can now send messages to the server to produce events</p>
        <hr>
    </body>
</html>
